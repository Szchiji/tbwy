<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…å®¹è¯¦æƒ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #f1f1f1; }
        .glass-panel { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); }
    </style>
</head>
<body class="pb-20">
    <div class="max-w-xl mx-auto px-4">
        <header class="flex items-center justify-between py-6">
            <button onclick="history.back()" class="text-blue-500 text-sm font-bold flex items-center gap-1">
                <span>â†</span> è¿”å›é¦–é¡µ
            </button>
            <div class="text-[10px] text-gray-600 font-mono tracking-widest">{{ post.date }}</div>
        </header>

        <!-- åª’ä½“å±•ç¤º -->
        <div class="space-y-4 mb-8">
            {% for m in all_media %}
                {% if m %}
                <div class="rounded-[2.5rem] overflow-hidden border border-white/5 bg-black shadow-2xl">
                    {% if m.lower().endswith('.mp4') %}
                        <video src="{{ m }}" controls playsinline class="w-full block"></video>
                    {% else %}
                        <img src="{{ m }}" class="w-full block shadow-inner">
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- æ­£æ–‡ -->
        <div class="glass-panel p-8 rounded-[2.5rem] mb-10 text-[16px] leading-relaxed text-gray-200 whitespace-pre-wrap shadow-xl">{{ post.text or "æš‚æ— è¯¦ç»†æ–‡æ¡ˆè¯´æ˜ã€‚" }}</div>

        <!-- ç®¡ç†å‘˜è‡ªå®šä¹‰æè¿° -->
        {% if post.custom_description %}
        <div class="glass-panel p-6 rounded-2xl mb-6 text-[14px] leading-relaxed text-blue-300 border border-blue-500/20">
            ğŸ“ {{ post.custom_description }}
        </div>
        {% endif %}

        <!-- äº’åŠ¨ -->
        <div class="flex gap-3 mb-10">
            <button id="likeBtn" onclick="handleLike()" class="flex-1 bg-blue-600/10 py-5 rounded-2xl text-center border border-blue-500/20 transition-all active:scale-95">
                <span id="likeTxt" class="text-blue-400 font-black tracking-widest">â¤ï¸ {{ post.likes }} LIKES</span>
            </button>
            <button id="blacklistBtn" onclick="handleBlacklist()" class="flex-1 bg-red-600/10 py-5 rounded-2xl text-center border border-red-500/20 transition-all active:scale-95">
                <span id="blacklistTxt" class="text-red-400 font-black tracking-widest">ğŸš« {{ post.blacklist_count or 0 }} æ‹‰é»‘</span>
            </button>
        </div>

        <!-- è¯„è®º -->
        <div class="space-y-6">
            <div class="flex gap-2">
                <input id="cmtInput" type="text" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." class="flex-1 bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-sm outline-none focus:border-blue-500">
                <button onclick="submitCmt()" class="bg-blue-600 px-6 py-3 rounded-2xl text-sm font-bold shadow-lg active:bg-blue-700">å‘å¸ƒ</button>
            </div>
            <div class="space-y-4">
                {% for c in comments %}
                <div class="glass-panel p-5 rounded-2xl">
                    <p class="text-[14px] text-gray-300 leading-relaxed">{{ c.content }}</p>
                    <div class="text-[10px] text-gray-600 mt-3 font-mono">{{ c.date }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        const pid = "{{ post.id }}";
        
        // ç”Ÿæˆæˆ–è·å–ç”¨æˆ·ID
        function getUserId() {
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substring(2, 11);
                localStorage.setItem('user_id', userId);
            }
            return userId;
        }
        
        // è·å–æ‹‰é»‘åˆ—è¡¨
        function getBlacklistedItems() {
            return JSON.parse(localStorage.getItem('m_blacklisted') || '[]');
        }
        
        // æ·»åŠ åˆ°æ‹‰é»‘åˆ—è¡¨
        function addToBlacklist(itemId) {
            let blacklisted = getBlacklistedItems();
            blacklisted.push(itemId);
            localStorage.setItem('m_blacklisted', JSON.stringify(blacklisted));
        }
        
        function handleLike() {
            let liked = JSON.parse(localStorage.getItem('m_liked') || '[]');
            if(liked.includes(pid)) return alert('æ‚¨å·²ç»ç‚¹è¿‡èµå•¦ï¼');
            fetch('/api/like/'+pid, {method:'POST'}).then(res => {
                if(res.ok) {
                    liked.push(pid);
                    localStorage.setItem('m_liked', JSON.stringify(liked));
                    const txt = document.getElementById('likeTxt');
                    const num = parseInt(txt.innerText.match(/\d+/)[0]) + 1;
                    txt.innerText = 'â¤ï¸ ' + num + ' LIKES';
                    document.getElementById('likeBtn').style.opacity = '0.5';
                }
            });
        }

        function handleBlacklist() {
            let blacklisted = getBlacklistedItems();
            if(blacklisted.includes(pid)) return alert('æ‚¨å·²ç»æ‹‰é»‘è¿‡æ­¤å†…å®¹ï¼');
            if(!confirm('ç¡®å®šè¦æ‹‰é»‘æ­¤å†…å®¹å—ï¼Ÿæ‹‰é»‘åå°†ä¸å†æ˜¾ç¤ºã€‚')) return;
            
            fetch('/api/blacklist/'+pid, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({user_id: getUserId()})
            }).then(res => {
                if(res.ok) {
                    addToBlacklist(pid);
                    const txt = document.getElementById('blacklistTxt');
                    const num = parseInt(txt.innerText.match(/\d+/)[0]) + 1;
                    txt.innerText = 'ğŸš« ' + num + ' æ‹‰é»‘';
                    document.getElementById('blacklistBtn').style.opacity = '0.5';
                    alert('å·²æ‹‰é»‘æ­¤å†…å®¹ï¼Œè¿”å›é¦–é¡µåå°†ä¸å†æ˜¾ç¤º');
                }
            });
        }

        function submitCmt() {
            const val = document.getElementById('cmtInput').value.trim();
            if(!val) return;
            fetch('/api/comment/'+pid, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({content: val})
            }).then(() => location.reload());
        }

        window.onload = () => {
            let liked = JSON.parse(localStorage.getItem('m_liked') || '[]');
            if(liked.includes(pid)) document.getElementById('likeBtn').style.opacity = '0.5';
            
            let blacklisted = getBlacklistedItems();
            if(blacklisted.includes(pid)) document.getElementById('blacklistBtn').style.opacity = '0.5';
        };
    </script>
</body>
</html>