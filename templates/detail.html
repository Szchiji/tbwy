<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…å®¹è¯¦æƒ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #f1f1f1; }
        .glass-panel { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); }
        .admin-desc { background: linear-gradient(135deg, rgba(59,130,246,0.1) 0%, rgba(147,51,234,0.1) 100%); border: 1px solid rgba(59,130,246,0.3); }
        a { color: #60a5fa; text-decoration: underline; }
        a:hover { color: #93c5fd; }
    </style>
</head>
<body class="pb-20">
    <div class="max-w-xl mx-auto px-4">
        <header class="flex items-center justify-between py-6">
            <button onclick="history.back()" class="text-blue-500 text-sm font-bold flex items-center gap-1">
                <span>â†</span> è¿”å›é¦–é¡µ
            </button>
            <div class="text-[10px] text-gray-600 font-mono tracking-widest">{{ post.date }}</div>
        </header>

        <!-- ç®¡ç†å‘˜è‡ªå®šä¹‰æè¿° - æ”¾åœ¨æœ€å‰é¢ï¼Œæ›´é†’ç›® -->
        {% if post.custom_description %}
        <div class="admin-desc p-6 rounded-2xl mb-6 text-[14px] leading-relaxed text-blue-300">
            <div class="flex items-center gap-2 mb-2">
                <span class="text-lg">ğŸ“</span>
                <span class="font-bold text-blue-400">ç®¡ç†å‘˜å¤‡æ³¨</span>
            </div>
            <div class="linkify">{{ post.custom_description }}</div>
        </div>
        {% endif %}

        <!-- åª’ä½“å±•ç¤º -->
        <div class="space-y-4 mb-8">
            {% for m in all_media %}
                {% if m %}
                <div class="rounded-[2.5rem] overflow-hidden border border-white/5 bg-black shadow-2xl">
                    {% if m.lower().endswith('.mp4') or m.lower().endswith('.mov') %}
                        <!-- è§†é¢‘å¸¦å°é¢ -->
                        {% set thumb_url = m.replace('.mp4', '_thumb.jpg').replace('.MP4', '_thumb.jpg').replace('.mov', '_thumb.jpg').replace('.MOV', '_thumb.jpg') %}
                        <video src="{{ m }}" poster="{{ thumb_url }}" controls playsinline class="w-full block"></video>
                    {% else %}
                        <img src="{{ m }}" class="w-full block shadow-inner">
                    {% endif %}
                </div>
                {% endif %}
            {% endfor %}
        </div>

        <!-- æ­£æ–‡ - é“¾æ¥å¯ç‚¹å‡» -->
        <div class="glass-panel p-8 rounded-[2.5rem] mb-10 text-[16px] leading-relaxed text-gray-200 whitespace-pre-wrap shadow-xl linkify" id="postContent">{{ post.text or "æš‚æ— è¯¦ç»†æ–‡æ¡ˆè¯´æ˜ã€‚" }}</div>

        <!-- äº’åŠ¨ -->
        <div class="flex gap-3 mb-10">
            <button id="likeBtn" onclick="handleLike()" class="flex-1 bg-blue-600/10 py-5 rounded-2xl text-center border border-blue-500/20 transition-all active:scale-95">
                <span id="likeTxt" class="text-blue-400 font-black tracking-widest">â¤ï¸ {{ post.likes }} LIKES</span>
            </button>
            <button id="blacklistBtn" onclick="handleBlacklist()" class="flex-1 bg-red-600/10 py-5 rounded-2xl text-center border border-red-500/20 transition-all active:scale-95">
                <span id="blacklistTxt" class="text-red-400 font-black tracking-widest">ğŸš« {{ post.blacklist_count or 0 }} æ‹‰é»‘</span>
            </button>
        </div>

        <!-- è¯„è®º -->
        <div class="space-y-6">
            <div class="flex gap-2">
                <input id="cmtInput" type="text" placeholder="è¯´ç‚¹ä»€ä¹ˆå§..." class="flex-1 bg-white/5 border border-white/10 rounded-2xl px-5 py-3 text-sm outline-none focus:border-blue-500">
                <button onclick="submitCmt()" class="bg-blue-600 px-6 py-3 rounded-2xl text-sm font-bold shadow-lg active:bg-blue-700">å‘å¸ƒ</button>
            </div>
            <div class="space-y-4" id="commentsList">
                {% for c in comments %}
                <div class="glass-panel p-5 rounded-2xl relative" data-comment-id="{{ c.id }}">
                    <p class="text-[14px] text-gray-300 leading-relaxed linkify">{{ c.content }}</p>
                    <div class="flex justify-between items-center mt-3">
                        <div class="text-[10px] text-gray-600 font-mono">{{ c.date }}</div>
                        <button onclick="deleteComment({{ c.id }})" class="text-red-400 text-xs hover:text-red-300 transition">ğŸ—‘ï¸ åˆ é™¤</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        const pid = "{{ post.id }}";
        
        // ç”Ÿæˆæˆ–è·å–ç”¨æˆ·ID
        function getUserId() {
            let userId = localStorage.getItem('user_id');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substring(2, 11);
                localStorage.setItem('user_id', userId);
            }
            return userId;
        }
        
        // è·å–æ‹‰é»‘åˆ—è¡¨
        function getBlacklistedItems() {
            return JSON.parse(localStorage.getItem('m_blacklisted') || '[]');
        }
        
        // æ·»åŠ åˆ°æ‹‰é»‘åˆ—è¡¨
        function addToBlacklist(itemId) {
            let blacklisted = getBlacklistedItems();
            blacklisted.push(itemId);
            localStorage.setItem('m_blacklisted', JSON.stringify(blacklisted));
        }
        
        function handleLike() {
            let liked = JSON.parse(localStorage.getItem('m_liked') || '[]');
            if(liked.includes(pid)) return alert('æ‚¨å·²ç»ç‚¹è¿‡èµå•¦ï¼');
            fetch('/api/like/'+pid, {method:'POST'}).then(res => {
                if(res.ok) {
                    liked.push(pid);
                    localStorage.setItem('m_liked', JSON.stringify(liked));
                    const txt = document.getElementById('likeTxt');
                    const num = parseInt(txt.innerText.match(/\d+/)[0]) + 1;
                    txt.innerText = 'â¤ï¸ ' + num + ' LIKES';
                    document.getElementById('likeBtn').style.opacity = '0.5';
                }
            });
        }

        function handleBlacklist() {
            let blacklisted = getBlacklistedItems();
            if(blacklisted.includes(pid)) return alert('æ‚¨å·²ç»æ‹‰é»‘è¿‡æ­¤å†…å®¹ï¼');
            if(!confirm('ç¡®å®šè¦æ‹‰é»‘æ­¤å†…å®¹å—ï¼Ÿæ‹‰é»‘åå°†ä¸å†æ˜¾ç¤ºã€‚')) return;
            
            fetch('/api/blacklist/'+pid, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({user_id: getUserId()})
            }).then(res => {
                if(res.ok) {
                    addToBlacklist(pid);
                    const txt = document.getElementById('blacklistTxt');
                    const num = parseInt(txt.innerText.match(/\d+/)[0]) + 1;
                    txt.innerText = 'ğŸš« ' + num + ' æ‹‰é»‘';
                    document.getElementById('blacklistBtn').style.opacity = '0.5';
                    alert('å·²æ‹‰é»‘æ­¤å†…å®¹ï¼Œè¿”å›é¦–é¡µåå°†ä¸å†æ˜¾ç¤º');
                }
            });
        }

        function submitCmt() {
            const val = document.getElementById('cmtInput').value.trim();
            if(!val) return;
            fetch('/api/comment/'+pid, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({content: val, user_id: getUserId()})
            }).then(() => location.reload());
        }
        
        function deleteComment(commentId) {
            if(!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ')) return;
            fetch('/api/comment/'+commentId, {
                method:'DELETE',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({user_id: getUserId()})
            }).then(res => {
                if(res.ok) {
                    document.querySelector('[data-comment-id="'+commentId+'"]').remove();
                } else {
                    alert('åˆ é™¤å¤±è´¥');
                }
            });
        }
        
        // å°†æ–‡æœ¬ä¸­çš„ URL è½¬æ¢ä¸ºå¯ç‚¹å‡»é“¾æ¥ï¼ˆå®‰å…¨å¤„ç†ï¼‰
        function linkify(text) {
            const urlPattern = /(https?:\/\/[^\s<]+)/g;
            // é¦–å…ˆè½¬ä¹‰ HTML ç‰¹æ®Šå­—ç¬¦
            const div = document.createElement('div');
            div.textContent = text;
            const escapedText = div.innerHTML;
            // ç„¶åå°† URL è½¬æ¢ä¸ºé“¾æ¥
            return escapedText.replace(urlPattern, function(url) {
                // å†æ¬¡è½¬ä¹‰ URL ä»¥é˜²æ­¢ XSS
                const a = document.createElement('a');
                a.href = url;
                a.textContent = url;
                a.target = '_blank';
                a.rel = 'noopener noreferrer';
                return a.outerHTML;
            });
        }

        window.onload = () => {
            let liked = JSON.parse(localStorage.getItem('m_liked') || '[]');
            if(liked.includes(pid)) document.getElementById('likeBtn').style.opacity = '0.5';
            
            let blacklisted = getBlacklistedItems();
            if(blacklisted.includes(pid)) document.getElementById('blacklistBtn').style.opacity = '0.5';
            
            // å°†æ­£æ–‡å’Œè¯„è®ºä¸­çš„é“¾æ¥è½¬æ¢ä¸ºå¯ç‚¹å‡»
            document.querySelectorAll('.linkify').forEach(el => {
                const originalText = el.textContent || el.innerText;
                el.innerHTML = linkify(originalText);
            });
        };
    </script>
</body>
</html>