<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>详情 - Matrix Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>body { background: #020408; color: #f1f5f9; }</style>
</head>
<body class="pb-10">
    <div class="bg-blue-600/10 py-2 text-center text-[10px] text-blue-400 border-b border-blue-500/20 font-bold tracking-widest">{{ notice }}</div>

    <div class="max-w-xl mx-auto px-4">
        <header class="py-6 flex items-center justify-between">
            <button onclick="history.back()" class="text-blue-500 text-sm flex items-center gap-1"><i class="bi bi-chevron-left"></i> 返回首页</button>
            <div class="text-[10px] text-slate-500">FROM: <span class="text-blue-400">@{{ post.username }}</span></div>
        </header>

        <div class="rounded-3xl overflow-hidden bg-black mb-6 border border-white/5">
            <script async src="https://telegram.org/js/telegram-widget.js?22" 
                data-telegram-post="{{ post.username }}/{{ post.msg_id }}" data-width="100%" data-dark="1"></script>
        </div>

        <div class="flex justify-between items-center mb-8 bg-white/5 p-4 rounded-2xl border border-white/5">
            <button onclick="like({{ post.id }})" class="flex items-center gap-2 text-slate-300">
                <i class="bi bi-heart-fill text-rose-500"></i> <span id="like-count">{{ post.likes }}</span>
            </button>
            <span class="text-[10px] text-slate-600 font-mono italic underline">#POST-ID: {{ post.id }}</span>
        </div>

        <div class="p-6 bg-white/5 rounded-3xl mb-8 border border-white/5">
            <p class="text-sm leading-loose whitespace-pre-wrap text-slate-200">{{ post.text }}</p>
        </div>

        <div class="mt-10 border-t border-white/5 pt-8">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-2"><i class="bi bi-shield-lock-fill text-yellow-500"></i><h3 class="text-xs font-bold text-slate-400">管理员描述</h3></div>
                <button onclick="toggleEdit()" class="text-[10px] text-blue-500 underline">编辑备注</button>
            </div>
            
            <div class="p-5 bg-yellow-500/5 border border-yellow-500/10 rounded-3xl">
                <p class="text-sm text-yellow-100/70 leading-relaxed italic" id="display-note">
                    {{ post.admin_note if post.admin_note else '暂无管理员评价内容。' }}
                </p>
            </div>

            <div id="edit-panel" class="hidden mt-4 p-5 bg-slate-900 rounded-3xl border border-blue-500/30">
                <input type="password" id="admin-pwd" placeholder="管理密码" class="w-full bg-black border border-white/10 rounded-xl px-4 py-2 text-xs mb-3">
                <textarea id="admin-text" rows="4" class="w-full bg-black border border-white/10 rounded-xl px-4 py-2 text-xs mb-3">{{ post.admin_note }}</textarea>
                <button onclick="saveNote({{ post.id }})" class="w-full bg-blue-600 py-3 rounded-xl text-xs font-bold uppercase tracking-widest">保存更新</button>
            </div>
        </div>
    </div>

    <script>
        function toggleEdit() { document.getElementById('edit-panel').classList.toggle('hidden'); }
        async function like(id) {
            await fetch(`/api/like/${id}`, {method:'POST'});
            document.getElementById('like-count').innerText = parseInt(document.getElementById('like-count').innerText) + 1;
        }
        async function saveNote(pid) {
            const pwd = document.getElementById('admin-pwd').value;
            const text = document.getElementById('admin-text').value;
            const res = await fetch('/api/set_note', {
                method:'POST', headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ post_id: pid, password: pwd, content: text })
            });
            if(res.ok) { alert("备注已成功保存！"); location.reload(); } else { alert("权限验证失败！"); }
        }
    </script>
</body>
</html>