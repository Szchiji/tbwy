<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Matrix | 智能情报站</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root { --bg-dark: #020408; --card-dark: #0a0d14; }
        body { background-color: var(--bg-dark); color: #f1f5f9; font-family: sans-serif; }
        .neon-blue { border: 1px solid rgba(59,130,246,0.3); box-shadow: 0 0 15px rgba(59,130,246,0.1); }
        .neon-amber { border: 1px solid rgba(245,158,11,0.4); box-shadow: 0 0 15px rgba(245,158,11,0.1); }
        .neon-red { border: 1px solid rgba(239,68,68,0.4); box-shadow: 0 0 15px rgba(239,68,68,0.1); }
        .glass { background: rgba(2,4,8,0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        mark { background: #fbbf24; color: #000; border-radius: 4px; padding: 0 2px; }
    </style>
</head>
<body class="pb-24">

    <header class="glass sticky top-0 z-50 px-4 py-4 border-b border-white/5">
        <div class="max-w-2xl mx-auto space-y-4">
            <div class="flex items-center gap-4">
                <div class="h-10 w-10 rounded-xl bg-blue-600 flex items-center justify-center shadow-lg shadow-blue-500/20">
                    <i class="bi bi-cpu text-white"></i>
                </div>
                <input type="text" id="mSearch" oninput="runFilter()" placeholder="搜索情报内容..." 
                       class="flex-1 bg-white/5 border border-white/10 rounded-xl py-2 pl-10 pr-4 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
            </div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar">
                <button onclick="filterT('', this)" class="bg-blue-600 px-4 py-1 rounded-full text-[10px] font-bold">全部</button>
                {% for tag in all_tags %}
                <button onclick="filterT('{{ tag }}', this)" class="bg-white/5 border border-white/10 px-4 py-1 rounded-full text-[10px] text-slate-400 whitespace-nowrap">#{{ tag }}</button>
                {% endfor %}
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 mt-8 space-y-8" id="flow">
        {% for post in posts %}
        <article class="post-card bg-[#0a0d14] rounded-[2rem] overflow-hidden 
                       {% if post.sentiment > 0.3 %} neon-amber {% elif post.sentiment < -0.3 %} neon-red {% else %} neon-blue {% endif %}"
                 data-text="{{ post.text|lower }}" data-tags="{{ post.tags }}">
            
            <div class="min-h-[100px] bg-black/40">
                <script async src="https://telegram.org/js/telegram-widget.js?22" 
                        data-telegram-post="{{ post.username }}/{{ post.msg_id }}" data-width="100%" data-dark="1"></script>
            </div>

            <div class="p-6">
                <p class="p-text text-slate-400 text-sm mb-6">{{ post.text }}</p>

                <div class="space-y-2 mb-6 border-t border-white/5 pt-4">
                    <span class="text-[10px] font-bold text-slate-600 uppercase tracking-tighter">互动留言</span>
                    <div class="space-y-2 overflow-y-auto max-h-32 no-scrollbar">
                        {% for c in comments %}{% if c.post_id == post.msg_id %}
                        <div class="text-xs bg-white/5 p-2 rounded-lg border border-white/5">
                            <span class="text-blue-500 text-[9px] mr-2">{{ c.date }}</span> {{ c.content }}
                        </div>
                        {% endif %}{% endfor %}
                    </div>
                    <div class="flex gap-2 mt-4">
                        <input type="text" id="ipt-{{ post.msg_id }}" placeholder="发表你的看法..." 
                               class="flex-1 bg-white/5 border border-white/10 rounded-lg px-3 py-1.5 text-xs outline-none focus:border-blue-500 transition-all">
                        <button onclick="sendComment({{ post.msg_id }})" class="bg-blue-600 px-4 py-1.5 rounded-lg text-xs font-bold">发送</button>
                    </div>
                </div>

                <div class="flex justify-between items-center border-t border-white/5 pt-5">
                    <div class="flex gap-4">
                        <button onclick="doLike({{ post.msg_id }}, this)" class="text-slate-500 hover:text-rose-500 text-xs">
                            <i class="bi bi-heart-fill mr-1"></i><span>{{ post.likes }}</span>
                        </button>
                        <button onclick="doDel({{ post.msg_id }}, '{{ post.username }}')" class="text-white/5 hover:text-red-500 text-[10px] uppercase">删除</button>
                    </div>
                    <span class="text-[10px] font-bold text-blue-500 uppercase">{{ post.title }}</span>
                </div>
            </div>
        </article>
        {% endfor %}
    </main>

    <div id="subM" class="hidden fixed inset-0 z-[100] glass flex items-center justify-center p-4">
        <div class="bg-[#0d111a] border border-white/10 w-full max-w-sm rounded-3xl p-8">
            <h3 class="text-lg font-bold mb-4">匿名投稿</h3>
            <textarea id="subC" class="w-full h-32 bg-white/5 border border-white/10 rounded-xl p-4 text-sm mb-4 outline-none focus:ring-1 focus:ring-blue-500"></textarea>
            <div class="flex gap-3">
                <button onclick="closeS()" class="flex-1 py-3 bg-white/5 rounded-xl text-xs">取消</button>
                <button onclick="subS()" class="flex-1 py-3 bg-blue-600 rounded-xl text-xs font-bold">提交审核</button>
            </div>
        </div>
    </div>
    <button onclick="openS()" class="fixed bottom-8 right-8 w-14 h-14 bg-blue-600 rounded-full shadow-2xl flex items-center justify-center z-50">
        <i class="bi bi-pencil-square text-white text-xl"></i>
    </button>

    <script>
        let curTag = '';
        function filterT(t, el) {
            curTag = t;
            document.querySelectorAll('.tag-btn').forEach(b => b.classList.remove('bg-blue-600'));
            if(el) el.classList.add('bg-blue-600');
            runFilter();
        }
        function runFilter() {
            const k = document.getElementById('mSearch').value.toLowerCase();
            document.querySelectorAll('.post-card').forEach(card => {
                const tEl = card.querySelector('.p-text');
                const raw = tEl.innerText;
                const mK = raw.toLowerCase().includes(k);
                const mT = curTag === '' || card.dataset.tags.includes(curTag);
                if(mK && mT) {
                    card.style.display = 'block';
                    tEl.innerHTML = k ? raw.replace(new RegExp(`(${k})`, 'gi'), '<mark>$1</mark>') : raw;
                } else card.style.display = 'none';
            });
        }
        async function doLike(id, el) {
            const res = await fetch(`/api/like/${id}`, {method:'POST'});
            if(res.ok) { el.classList.add('text-rose-500'); el.querySelector('span').innerText = parseInt(el.querySelector('span').innerText)+1; }
        }
        function openS() { document.getElementById('subM').classList.remove('hidden'); }
        function closeS() { document.getElementById('subM').classList.add('hidden'); }
        async function subS() {
            const content = document.getElementById('subC').value;
            if(!content) return;
            const res = await fetch('/api/submit', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content})});
            if(res.ok) { alert("已提交后台审核"); closeS(); }
        }
        async function sendComment(id) {
            const ipt = document.getElementById(`ipt-${id}`);
            if(!ipt.value) return;
            const res = await fetch('/api/comment', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({post_id:id, content:ipt.value})});
            if(res.ok) location.reload();
        }
        async function doDel(id, user) {
            const pwd = prompt("管理员身份验证:");
            if(!pwd) return;
            const res = await fetch(`/api/delete/${id}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pwd, username:user})});
            if(res.ok) location.reload();
        }
    </script>
</body>
</html>