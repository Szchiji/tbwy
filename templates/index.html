<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Hub | 极客情报</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background: #020408; color: #f1f5f9; font-family: sans-serif; }
        .post-card { background: #0a0d14; border: 1px solid rgba(255,255,255,0.05); border-radius: 24px; overflow: hidden; margin-bottom: 30px; }
        .is-pinned { border: 1px solid rgba(59, 130, 246, 0.6); box-shadow: 0 0 20px rgba(59, 130, 246, 0.15); }
        .tg-container { position: relative; width: 100%; overflow: hidden; margin-top: -55px; }
        .tg-wrapper { background: #000; border-radius: 20px; overflow: hidden; }
        .glass { background: rgba(2,4,8,0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .comment-nest { margin-left: 2rem; border-left: 1px dashed rgba(255,255,255,0.1); padding-left: 1rem; }
        .clicked { color: #3b82f6 !important; pointer-events: none; }
        .hidden-post { display: none !important; }
    </style>
</head>
<body class="pb-24">

    <header class="glass sticky top-0 z-50 px-6 py-4 border-b border-white/5 flex justify-between items-center">
        <div class="flex items-center gap-2">
            <span class="text-blue-500 font-black text-xl">MATRIX</span>
            {% if posts|length > 0 %}<span class="bg-blue-500/10 text-blue-500 text-[10px] px-2 py-0.5 rounded">LIVE</span>{% endif %}
        </div>
        <button onclick="localStorage.clear(); location.reload();" class="text-[10px] opacity-30 hover:opacity-100">重置本地偏好</button>
    </header>

    <main class="max-w-xl mx-auto px-4 mt-6">
        {% for post in posts %}
        <div class="post-card {% if post.is_pinned %} is-pinned {% endif %}" id="card-{{ post.id }}">
            
            {% if post.is_pinned %}
            <div class="bg-blue-600/20 text-blue-400 text-[10px] px-4 py-1.5 font-bold flex items-center gap-2">
                <i class="bi bi-pin-angle-fill"></i> 管理员置顶
            </div>
            {% endif %}

            <div class="tg-wrapper">
                <div class="tg-container">
                    <script async src="https://telegram.org/js/telegram-widget.js?22" 
                            data-telegram-post="{{ post.username }}/{{ post.msg_id }}" data-width="100%" data-userpic="false" data-dark="1"></script>
                </div>
            </div>

            <div class="p-6">
                <div class="space-y-4 mb-6">
                    <div class="text-[11px] font-black text-slate-600 uppercase tracking-widest">评论讨论</div>
                    <div id="comment-list-{{ post.id }}" class="space-y-3">
                        {% for c in comments %}{% if c.post_id == post.id and c.parent_id == 0 %}
                            <div class="bg-white/[0.03] p-3 rounded-xl border border-white/5">
                                <div class="text-xs text-slate-300">{{ c.content }}</div>
                                <div class="flex justify-between mt-2 items-center">
                                    <span class="text-[9px] text-slate-600">{{ c.date }}</span>
                                    <button onclick="setReply({{ post.id }}, {{ c.id }}, '{{ c.content[:10] }}...')" class="text-blue-500 text-[10px] font-bold">回复</button>
                                </div>
                            </div>
                            {% for sub in comments %}{% if sub.parent_id == c.id %}
                            <div class="comment-nest mt-2">
                                <div class="bg-blue-500/[0.03] p-2 rounded-lg border border-blue-500/10 text-[11px] text-slate-400">
                                    <span class="text-blue-500/50">@RE:</span> {{ sub.content }}
                                </div>
                            </div>
                            {% endif %}{% endfor %}
                        {% endif %}{% endfor %}
                    </div>
                </div>

                <div class="bg-white/5 p-2 rounded-2xl border border-white/10 mb-6">
                    <div id="reply-to-{{ post.id }}" class="hidden text-[10px] bg-blue-600/20 px-2 py-1 rounded mb-2 flex justify-between">
                        <span id="reply-text-{{ post.id }}"></span>
                        <button onclick="cancelReply({{ post.id }})">取消</button>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="ipt-{{ post.id }}" placeholder="说点什么..." class="flex-1 bg-transparent px-2 py-1 text-sm outline-none">
                        <button onclick="sendC({{ post.id }})" class="bg-blue-600 px-4 py-2 rounded-xl text-xs font-bold shadow-lg shadow-blue-600/20">发送</button>
                    </div>
                </div>

                <div class="flex justify-between items-center text-[11px] border-t border-white/5 pt-4">
                    <div class="flex gap-6">
                        <button id="like-{{ post.id }}" onclick="doLike({{ post.id }})" class="flex items-center gap-1.5 hover:text-rose-500">
                            <i class="bi bi-heart-fill"></i> <span id="lcnt-{{ post.id }}">{{ post.likes }}</span>
                        </button>
                        <button onclick="localBlock({{ post.id }})" class="hover:text-orange-500"><i class="bi bi-eye-slash-fill"></i> 拉黑</button>
                    </div>
                    <div class="flex gap-4 text-white/10 font-bold uppercase">
                        <button onclick="adminPin({{ post.id }})" class="hover:text-blue-500">置顶</button>
                        <button onclick="adminDel({{ post.msg_id }}, '{{ post.username }}')" class="hover:text-red-500">删除</button>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </main>

    <script>
        const STORAGE_LIKE = 'm_liked', STORAGE_BLOCK = 'm_blocked';
        let replyMap = {}; // 记录每个帖子的回复对象

        // 回复逻辑
        function setReply(postId, commentId, text) {
            replyMap[postId] = commentId;
            const bar = document.getElementById(`reply-to-${postId}`);
            bar.classList.remove('hidden');
            document.getElementById(`reply-text-${postId}`).innerText = `正在回复: ${text}`;
        }
        function cancelReply(postId) {
            delete replyMap[postId];
            document.getElementById(`reply-to-${postId}`).classList.add('hidden');
        }

        async function sendC(postId) {
            const ipt = document.getElementById(`ipt-${postId}`);
            if(!ipt.value) return;
            const parentId = replyMap[postId] || 0;
            const res = await fetch('/api/comment', {
                method:'POST', 
                headers:{'Content-Type':'application/json'}, 
                body:JSON.stringify({post_id:postId, parent_id:parentId, content:ipt.value})
            });
            if(res.ok) location.reload();
            else if(res.status === 400) alert("评论包含违禁词");
        }

        // 管理员置顶
        async function adminPin(id) {
            const pwd = prompt("管理员密码:");
            if(!pwd) return;
            await fetch(`/api/pin/${id}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pwd})});
            location.reload();
        }

        // 点赞、拉黑、初始化 (与之前逻辑一致，确保 ID 匹配)
        async function doLike(id) {
            let liked = JSON.parse(localStorage.getItem(STORAGE_LIKE) || '[]');
            if(liked.includes(id)) return;
            if((await fetch(`/api/like/${id}`, {method:'POST'})).ok) {
                liked.push(id); localStorage.setItem(STORAGE_LIKE, JSON.stringify(liked));
                const s = document.getElementById(`lcnt-${id}`); s.innerText = parseInt(s.innerText)+1;
                document.getElementById(`like-${id}`).classList.add('clicked');
            }
        }
        function localBlock(id) {
            if(!confirm("隐藏后不再显示？")) return;
            let b = JSON.parse(localStorage.getItem(STORAGE_BLOCK) || '[]');
            b.push(id); localStorage.setItem(STORAGE_BLOCK, JSON.stringify(b));
            document.getElementById(`card-${id}`).classList.add('hidden-post');
        }
        async function adminDel(mid, user) {
            const pwd = prompt("管理员密码:"); if(!pwd) return;
            await fetch(`/api/delete/${mid}`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({password:pwd, username:user})});
            location.reload();
        }
        document.addEventListener('DOMContentLoaded', () => {
            const b = JSON.parse(localStorage.getItem(STORAGE_BLOCK) || '[]');
            b.forEach(id => document.getElementById(`card-${id}`)?.classList.add('hidden-post'));
            const l = JSON.parse(localStorage.getItem(STORAGE_LIKE) || '[]');
            l.forEach(id => document.getElementById(`like-${id}`)?.classList.add('clicked'));
        });
    </script>
</body>
</html>