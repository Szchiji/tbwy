<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matrix Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #050505; color: #f1f1f1; font-family: system-ui, sans-serif; }
        .post-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        .loading-text { text-align: center; padding: 20px; font-size: 12px; color: #444; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-feed { animation: fadeIn 0.4s ease forwards; }
    </style>
</head>
<body class="pb-10">
    <nav class="sticky top-0 z-50 bg-black/80 backdrop-blur-xl border-b border-white/5 p-4">
        <div class="max-w-xl mx-auto space-y-3">
            <h1 class="text-xl font-black text-blue-500 text-center tracking-tighter">MATRIX HUB</h1>
            {% if notice %}<div class="text-[10px] text-center text-blue-300 py-1.5 bg-blue-500/10 rounded-xl border border-blue-500/20 px-4">{{ notice }}</div>{% endif %}
            <form id="searchForm" class="relative">
                <input type="text" id="searchInp" name="q" value="{{q}}" placeholder="ÊêúÁ¥¢ÂÖ≥ÈîÆËØç..." class="w-full bg-white/5 border border-white/10 rounded-2xl py-2.5 px-4 text-sm outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all">
            </form>
        </div>
    </nav>

    <main id="postList" class="max-w-xl mx-auto px-4 mt-6 space-y-4"></main>
    <div id="loading" class="loading-text">Ê≠£Âú®Âä†ËΩΩÊõ¥Â§öÂÜÖÂÆπ...</div>

    <script>
        let page = 1;
        let loading = false;
        let hasMore = true;
        const query = new URLSearchParams(window.location.search).get('q') || '';

        async function fetchPosts() {
            if (loading || !hasMore) return;
            loading = true;
            document.getElementById('loading').style.display = 'block';

            try {
                const res = await fetch(`/api/posts?page=${page}&q=${query}`);
                const posts = await res.json();

                if (posts.length === 0) {
                    hasMore = false;
                    document.getElementById('loading').innerText = page === 1 ? 'ÊöÇÊó†ÊêúÁ¥¢ÁªìÊûú' : 'Â∑≤Ëß¶ÂèäÂÆáÂÆôËæπÁïå';
                    return;
                }

                const list = document.getElementById('postList');
                posts.forEach(p => {
                    const isVideo = p.first_media && p.first_media.toLowerCase().endsWith('.mp4');
                    const card = `
                        <div id="p-${p.id}" class="post-card rounded-[2rem] p-4 flex gap-5 animate-feed">
                            <a href="/post/${p.id}" class="w-28 h-28 rounded-2xl overflow-hidden bg-gray-900 flex-shrink-0 relative shadow-2xl">
                                <img src="${p.thumb_url || p.first_media}" class="w-full h-full object-cover" loading="lazy">
                                ${isVideo ? '<div class="absolute inset-0 flex items-center justify-center bg-black/20 text-white text-xs">‚ñ∂</div>' : ''}
                                ${p.media_group_id ? '<div class="absolute bottom-1 right-1 bg-black/60 text-[8px] px-1.5 py-0.5 rounded text-white/70">ÂõæÈõÜ</div>' : ''}
                            </a>
                            <div class="flex-1 min-w-0 flex flex-col justify-between py-1">
                                <a href="/post/${p.id}">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[10px] text-blue-500 font-mono font-bold">${p.date}</span>
                                        <span class="text-[9px] bg-white/5 px-2 py-0.5 rounded text-gray-500 uppercase">${p.title}</span>
                                    </div>
                                    <p class="text-[14px] text-gray-300 leading-snug line-clamp-3 whitespace-pre-wrap">${p.text || 'Êó†Ê†áÈ¢òÂÜÖÂÆπ'}</p>
                                </a>
                                <div class="flex justify-between items-center mt-2">
                                    <span class="text-[10px] text-gray-600 italic">üëÅ ${p.views || 0}</span>
                                    <button onclick="localBlock('${p.id}')" class="text-[10px] text-gray-700 hover:text-red-500 transition-colors">Â±èËîΩ</button>
                                </div>
                            </div>
                        </div>`;
                    list.insertAdjacentHTML('beforeend', card);
                });

                page++;
                checkLocalBlocks();
            } catch (err) { console.error(err); }
            loading = false;
            document.getElementById('loading').style.display = 'none';
        }

        function localBlock(id) {
            if(!confirm('Á°ÆÂÆöË¶ÅÂú®Êú¨Âú∞ÈöêËóèÊ≠§ÂÜÖÂÆπÂêóÔºü')) return;
            let blocks = JSON.parse(localStorage.getItem('m_blocks') || '[]');
            blocks.push(id.toString());
            localStorage.setItem('m_blocks', JSON.stringify(blocks));
            const el = document.getElementById('p-'+id);
            if(el) el.style.display = 'none';
        }

        function checkLocalBlocks() {
            let blocks = JSON.parse(localStorage.getItem('m_blocks') || '[]');
            blocks.forEach(id => {
                const el = document.getElementById('p-'+id);
                if(el) el.style.display = 'none';
            });
        }

        window.onscroll = () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 600) fetchPosts();
        };

        window.onload = fetchPosts;
    </script>
</body>
</html>